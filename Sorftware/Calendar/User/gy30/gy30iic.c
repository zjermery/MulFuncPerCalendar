#include "sys.h"

void gyIIC_Init(void)
{					     
	GPIO_InitTypeDef GPIO_InitStructure;
	
	RCC_APB2PeriphClockCmd(	RCC_APB2Periph_GPIOA, ENABLE );	//??GPIOB??
	   
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6|GPIO_Pin_7;	//SCL & SDA
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_OD ;   	//??/??
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_10MHz;		//?? 10 MHz
	GPIO_Init(GPIOA, &GPIO_InitStructure);
	GPIO_SetBits(GPIOA,GPIO_Pin_6|GPIO_Pin_7); 				//PB6,PB7 ???
}


void gyIIC_Start(void)
{
    gySDA_OUT();		/* SDA ????? */
    gyIIC_SDA = 1;	/* ??? SDA ?? */
    gyIIC_SCL = 1;	/* ??? SCL ?? */
    gyIIC_Delay();	/* ???????? */
    gyIIC_SDA = 0;	/* ??? SDA ?? */
    gyIIC_Delay();	/* ???????? */
    gyIIC_SCL = 0;	/* ??I2C,????? */
}




void gyIIC_Stop(void)
{
    gySDA_OUT();		/* SDA ????? */
    gyIIC_SCL = 0;	/* ??? SCL ?? */
    gyIIC_SDA = 0;	/* ??? SDA ?? */
    gyIIC_Delay();	/* ???????? */
    gyIIC_SCL = 1;	/* ??? SCL ?? */
    gyIIC_SDA = 1;	/* ??? SDA ?? */
    gyIIC_Delay();	/* ???????? */
}




uint8_t gyIIC_Wait_Ack(void)
{
    uint16_t ErrorTime;
	
    gySDA_IN();      			/** SDA ????? **/
    gyIIC_SDA = 1;			/* ??? SDA ?? */
    gyIIC_Delay();			/* ???????? */
    gyIIC_SCL = 1;			/* ??? SCL ?? */
    gyIIC_Delay();			/* ???????? */
	
    while(gyRead_SDA)			/* ?? SDA ???? */
    {
        ErrorTime ++;
		
        if(ErrorTime > 250)
        {
            gyIIC_Stop();		/* ???,???? */
            return 0;
        }
    }
    gyIIC_SCL = 0;			/** ??,????? **/
	
    return 1;				/** ??????? **/
}


/**
*	????:?? ACK ??
*
*	????:SCL ?????? SDA ???????
*			 (SCL ???? <= SDA ????)
*			  ??????????????
*
**/
void gyIIC_Ack(void)
{
	  gySDA_OUT();					/** SDA ????? **/
    gyIIC_SCL = 0;				/* ??? SCL ?? */
    gyIIC_SDA = 0;				/* ??? SDA ?? */
    gyIIC_Delay();				/* ???????? */
    gyIIC_SCL = 1;				/* ??? SCL ?? */
    gyIIC_Delay();				/* ???????? */
    gyIIC_SCL = 0;				/* ??? SCL ?? */
}


/**
*	????:?? NACK ??
*
*	????:SCL??????SDA???????
*			 (SCL ???? <= SDA ????)
*			  ??????????????
*
**/
void gyIIC_NAck(void)
{
	  gySDA_OUT();					/** SDA ????? **/
    gyIIC_SCL = 0;				/* ??? SCL ?? */
    gyIIC_SDA = 1;				/* ??? SDA ?? */
    gyIIC_Delay();				/* ???????? */
    gyIIC_SCL = 1;				/* ??? SCL ?? */
    gyIIC_Delay();				/* ???????? */
    gyIIC_SCL = 0;				/* ??? SCL ?? */
}



/**
*	????:IIC??????
*	????:Txd	??? 8 ?
*	
*	???:1, ???
*			0, ???
**/
void gyIIC_Send_Byte(uint8_t Txd)
{
    uint8_t T;
	
    gySDA_OUT();						/** ???SDA??? **/
    gyIIC_SCL = 0;					/** ??? SCL ?? **/
	
    for(T = 0; T < 8; T++)			/** ???????? */
    {
        gyIIC_SDA = (Txd & 0x80) >> 7;/** ??????? **/
        Txd <<= 1;					/* ???????? */
        gyIIC_Delay();				/* ???????? */
        gyIIC_SCL = 1;				/* ??? SCL ?? */
        gyIIC_Delay();				/* ???????? */
        gyIIC_SCL = 0;				/* ??? SCL ?? */
        gyIIC_Delay();				/* ???????? */
    }
}


/*
 * ????:IIC???
 * ????:ack = 1, ??ACK
 *			 ack = 0, ??NACK
 *
 * ???:??????????
 */
uint8_t gyIIC_Read_Byte(uint8_t ACK)
{
	uint8_t	T;
	uint8_t	Receive;

    gySDA_IN();				/** SDA ?????? **/
	
    for(T = 0; T < 8; T++ )	/** ????????**/
    {
        gyIIC_SCL = 0;		/* ????????,SDA????? */
        gyIIC_Delay();		/* ???????? */
        gyIIC_SCL = 1;		/* ?????,???SDA??,???? SDA */
        Receive <<= 1;		/** ???????? **/
        if(gyRead_SDA)
        {
            Receive++;		/** ???,?????1 **/
        }
        gyIIC_Delay();		/* ???????? */
    }
	
    if (!ACK)	
		gyIIC_NAck();			/** ?? NACK **/
    else		
		gyIIC_Ack(); 			/** ??  ACK **/
    return Receive;
}
